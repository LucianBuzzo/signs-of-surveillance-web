<!doctype HTML>
<html>

<head>
  <title>Signs of Surveillance</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="" />

  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
  <!-- load piEXIF.js -->
  <script src="js/piexif.js"></script>
  <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
  <h1 id='hero-title'>Signs of Surveillance</h1>
  <!--p>test piExif routine.
    <br /> <input id="piexif-file-input" type="file" />
  </p-->

  <div id="mapid"></div>

  <script>
    window.onload = function() {
      addSigns()
    };
    var mySigns = [];
    var myExif = [];
    var mymap = L.map('mapid').setView([51.505, -0.09], 13); // LONDON
    //var mymap = L.map('mapid').setView([52.379, 4.899], 13); // AMSTERDAM
    //var accessToken = "pk.eyJ1IjoiZGFuYnoiLCJhIjoiY2p0cnN1bXcxMDQ5aTN5bXZ1YmNja2QxNCJ9.Uy4SmkElJKCMLsxy-P8CJQ";
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Map Imagery © <a href="https://www.mapbox.com/">Mapbox</a>, all other materials  © <a href="https://www.buzzo.com/">Daniel Buzzo</a>',
      maxZoom: 20,
      //id: 'mapbox.streets',
      //id: 'mapbox.dark',
      id: 'mapbox.light',
      //id: 'mapbox.outdoors',
      //id: 'mapbox.satellite',
      accessToken: 'pk.eyJ1IjoiZGFuYnoiLCJhIjoiY2p0cnN1bXcxMDQ5aTN5bXZ1YmNja2QxNCJ9.Uy4SmkElJKCMLsxy-P8CJQ'
    }).addTo(mymap);

    // to setup signs as custom icons in an array of markers
    function addSigns() {
      var maxSigns = 20;
      for (i = 0; i < maxSigns; i++) {
        var imagePath = "./signs/sign" + i + ".jpg";
        convertFileToBase64viaFileReader(imagePath);
        /////// adding signs using markers /////////
        // var newSign = L.marker([piexif.GPSHelper.dmsRationalToDeg( myExif[i].GPSLatitude, myExif[i].GPSLatitudeRef ), piexif.GPSHelper.dmsRationalToDeg(myExif[i].GPSLongtitude, myExif[i].GPSLongtitudeRef ) ], riseOnHover = true, autoclose = false).addTo(mymap);
        // newSign.bindPopup("<div class ='sign_popup'><h1>DateStamp</h1><p  id ='signEXIF" + i + "'>EXIF data <p> <img id='sign" + i + "'src =" + imagePath + "></div>");

      }
    }
  </script>

  <script>
    //piexif load test
    function printExif(dataURL) {
      var originalImg = new Image();
      originalImg.src = dataURL;
      var exif = piexif.load(dataURL);
      originalImg.onload = function() {
        var w = originalImg.width;
        var h = originalImg.height;
        mySigns.push(originalImg);
        console.log("push" + originalImg);

        myExif.push(exif); // push exif data into array of exif data
        // console.log("push" + exif);
        // console.log( "orientation " + exif["0th"][piexif.ImageIFD.Orientation] ) ;
        // console.log( "GPSLatitude " + exif["GPS"][piexif.GPSIFD.GPSLatitude] ) ;

        var newSign = L.marker([piexif.GPSHelper.dmsRationalToDeg(exif["GPS"][piexif.GPSIFD.GPSLatitude], exif["GPS"][piexif.GPSIFD.GPSLatitudeRef]), piexif.GPSHelper.dmsRationalToDeg(exif["GPS"][piexif.GPSIFD.GPSLongitude],
          exif["GPS"][piexif.GPSIFD.GPSLongitudeRef])], riseOnHover = true, autoclose = false).addTo(mymap);

        newSign.bindPopup("<div class ='sign_popup'><h1>DateStamp</h1><p  id ='signEXIF" + "'>EXIF data <p> <img id='sign'src =" + originalImg.source + "></div>");
      }
    }

    function handleFileSelect(evt) {
      // var file = evt.target.files[0];
      // var reader = new FileReader();
      // reader.onloadend = function(e) {
      //   printExif(e.target.result);
      // };
      // reader.readAsDataURL(file);
      // new File("/signs/sign0.jpg", { type: 'image/jpeg' });
      // //reader.readAsDataURL(file);
      convertFileToBase64viaFileReader("./signs/sign0.jpg");
    }

    document.getElementById('piexif-file-input').addEventListener('change', handleFileSelect, false);
  </script>

  <script>
    function convertFileToBase64viaFileReader(url) {
      var xhr = new XMLHttpRequest();
      xhr.responseType = 'blob';
      xhr.onload = function() {
        var reader = new FileReader();
        reader.onloadend = function() {
          printExif(reader.result);
        }
        reader.readAsDataURL(xhr.response);
      };
      xhr.open('GET', url);
      xhr.send();
    }
  </script>
  <script>
    // function correctOrientation(image, exif) {
    //   var orientation = exif["0th"][piexif.TagValues.ImageIFD.Orientation];
    //
    //   var canvas = document.createElement("canvas");
    //   canvas.width = image.width;
    //   canvas.height = image.height;
    //   var ctx = canvas.getContext("2d");
    //   var x = 0;
    //   var y = 0;
    //   ctx.save();
    //   if (orientation == 2) {
    //     x = -canvas.width;
    //     ctx.scale(-1, 1);
    //   } else if (orientation == 3) {
    //     x = -canvas.width;
    //     y = -canvas.height;
    //     ctx.scale(-1, -1);
    //   } else if (orientation == 4) {
    //     y = -canvas.height;
    //     ctx.scale(1, -1);
    //   } else if (orientation == 5) {
    //     canvas.width = image.height;
    //     canvas.height = image.width;
    //     ctx.translate(canvas.width, canvas.height / canvas.width);
    //     ctx.rotate(Math.PI / 2);
    //     y = -canvas.width;
    //     ctx.scale(1, -1);
    //   } else if (orientation == 6) {
    //     canvas.width = image.height;
    //     canvas.height = image.width;
    //     ctx.translate(canvas.width, canvas.height / canvas.width);
    //     ctx.rotate(Math.PI / 2);
    //   } else if (orientation == 7) {
    //     canvas.width = image.height;
    //     canvas.height = image.width;
    //     ctx.translate(canvas.width, canvas.height / canvas.width);
    //     ctx.rotate(Math.PI / 2);
    //     x = -canvas.height;
    //     ctx.scale(-1, 1);
    //   } else if (orientation == 8) {
    //     canvas.width = image.height;
    //     canvas.height = image.width;
    //     ctx.translate(canvas.width, canvas.height / canvas.width);
    //     ctx.rotate(Math.PI / 2);
    //     x = -canvas.height;
    //     y = -canvas.width;
    //     ctx.scale(-1, -1);
    //   }
  </script>
</body>


</html>
