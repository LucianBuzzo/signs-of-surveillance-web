<!doctype HTML>
<html>

<head>
  <title>Signs of Surveillance</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="" />

  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
  <!-- load EXIF.js -->
  <script src="js/exif.js"></script>
  <!--script src= './js/geodesy-2.0.0/dms.js'></script-->
  <!-- <script type="module">
    import Dms from './js/geodesy-2.0.0/dms.js';

    new Dms();
    const lat = Dms.parse('51° 28′ 40.37″ N');
    console.log("Dms lat: " + lat);
      // DD = d + (min/60) + (sec/3600)
      // GeoLocation.LatComponents.degrees +
      // this->GeoLocation.LatComponents.minutes / 60 +
      // this->GeoLocation.LatComponents.seconds / 3600;
  </script> -->
  <style>
    /* typography and generic styling */
    h1#hero-title {
      font-family: sans-serif;
      /* margin-bottom: -20px;
      z-index: 1000; */
      padding: 0;
    }

    /* mapstyling */
    #mapid {
      height: 680px;
    }

    /* sign styling */
    .sign_popup h1 {
      font-size: 90%;
    }

    .sign_popup p {
      font-size: 90%;
    }

    .sign_popup img {
      width: 200px;
      border: 1px solid grey;
    }
  </style>
</head>

<body>
  <h1 id='hero-title'>Signs of Surveillance</h1>
  <p id='image-box'></p>
  <p>Upload a local file to read Exif data.
    <br /> <input id="file-input" type="file" />
  </p>

  <div id="mapid"></div>

  <script>
    // load exif data from loaded images in dom
    function getExifData(i) {
      var iconLat = 51.505; // some sample location values near london
      var iconLong = -0.09;
      var img = document.getElementById("image" + i);
      console.log("exifData function loaded image" + i + " : " + img);
      EXIF.getData(img, function() {
        var make = EXIF.getTag(this, "Make");
        var model = EXIF.getTag(this, "Model");
        var iconLat = EXIF.getTag(this, "GPSLatitude");
        var iconLong = EXIF.getTag(this, "GPSLongitude");
        var dateTime = EXIF.getTag(this, "DateTime");
        // here we convert EXIF lat long degrees to decimal degrees
        var decLat = iconLat[0] + iconLat[1] / 60 + iconLat[2] / 3600;
        var decLong = iconLong[0] + iconLong[1] / 60 + iconLong[2] / 3600;
        console.log("lat " + decLat + "  long " + decLong);
        console.log("make & model " + make, model);

        var newLatLng = L.latLng(decLat, decLong);
        var imagePath = "signs/sign" + i + ".jpg";
        mySigns[i].setLatLng(newLatLng);
        mySigns[i].bindPopup("<div class ='sign_popup'><h1>"+ dateTime +"</h1><p  id ='signEXIF" + i + "'>" + make + "<br>" + model + "<br>" + dateTime + "<p> <img id='sign" + i + "'src =" + imagePath + "></div>");
        //mySigns[i].popup().setContent("<div class ='sign_popup'><h1>DateStamp</h1><p  id ='signEXIF" + i + "'>" + make + " <p> <img id='sign" + i + "'src =" + imagePath + "></div>");
        // makeAndModel.innerHTML = `${make} ${model}`;
      });
    }
  </script>

  <script>
    var mySigns = [];
    var mymap = L.map('mapid').setView([51.505, -0.09], 13); // LONDON
    //var mymap = L.map('mapid').setView([52.379, 4.899], 13); // AMSTERDAM
    //var accessToken = "pk.eyJ1IjoiZGFuYnoiLCJhIjoiY2p0cnN1bXcxMDQ5aTN5bXZ1YmNja2QxNCJ9.Uy4SmkElJKCMLsxy-P8CJQ";
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Map Imagery © <a href="https://www.mapbox.com/">Mapbox</a>, all other materials  © <a href="https://www.buzzo.com/">Daniel Buzzo</a>',
      maxZoom: 20,
      //id: 'mapbox.streets',
      //id: 'mapbox.dark',
      id: 'mapbox.light',
      //id: 'mapbox.outdoors',
      //id: 'mapbox.satellite',
      accessToken: 'pk.eyJ1IjoiZGFuYnoiLCJhIjoiY2p0cnN1bXcxMDQ5aTN5bXZ1YmNja2QxNCJ9.Uy4SmkElJKCMLsxy-P8CJQ'
    }).addTo(mymap);

    // to setup signs as custom icons in an array of markers
    function addSigns() {
      var iconLat = 51.505; // start with some location near london
      var iconLong = -0.09;
      var maxSigns = 23;
      for (i = 0; i < maxSigns; i++) {
        var imagePath = "signs/sign" + i + ".jpg";
        ///////// adding signs using markers /////////
        var newSign = L.marker([iconLat, iconLong + (i / 100.0)], riseOnHover = true, autoclose = false).addTo(mymap);
        newSign.bindPopup("<div class ='sign_popup'><h1>DateStamp</h1><p  id ='signEXIF" + i + "'>EXIF data <p> <img id='sign" + i + "'src =" + imagePath + "></div>");
        // insert images into page under the title
        var insertSign = document.createElement('img');
        insertSign.setAttribute('src', imagePath);
        insertSign.setAttribute('width', '20px');
        insertSign.setAttribute('id', 'image' + i);
        var parent = document.getElementById('image-box');
        parent.insertBefore(insertSign, parent.firstChild);

        var img = new Image();
        img.onload = getExifData(i);
        img.src = imagePath;
        mySigns.push(newSign); // push into array of markers on the map
      }
    }
    addSigns();
  </script>

  <script>
    // exif js loading
    document.getElementById("file-input").onchange = function(e) {
      var file = e.target.files[0]
      if (file && file.name) {
        EXIF.getData(file, function() {
          var exifData = EXIF.pretty(this);
          if (exifData) {
            console.log(exifData);
            var make = EXIF.getTag(this, "Make");
            var model = EXIF.getTag(this, "Model");
            console.log("make and model " + make + model);
            alert(exifData);
          } else {
            alert("No EXIF data found in image '" + file.name + "'.");
          }
        });
      }
    }
  </script>
</body>

</html>
